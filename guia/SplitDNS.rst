Descripción general
====================

Las instalaciones de Zimbra detrás de un firewall (o enrutador NAT) a menudo requieren la creación de algún tipo de DNS dividido, también llamado DNS de horizonte dividido o de horizonte dual. Esta es una instalación de DNS donde las máquinas reciben diferentes respuestas de direcciones IP a las consultas dependiendo de si están (comúnmente) dentro o fuera de un firewall y una respuesta de dirección IP del servidor DNS proporciona una dirección IP de red privada que es diferente a la IP pública de su conexión a Internet. Para obtener más información sobre las direcciones IP de redes privadas, consulte el siguiente artículo: http://en.wikipedia.org/wiki/Private_network

Esto se debe a que el sistema de correo Postfix utilizado por Zimbra realiza una búsqueda de DNS MX para el servidor Zimbra seguida de una búsqueda de DNS A cuando se intenta enrutar el correo electrónico al almacén de mensajes de back-end. Con frecuencia, este es el mismo host físico que Postfix. El servidor DNS frecuentemente devuelve la dirección externa del servidor de correo, no la dirección interna. Dependiendo de cómo estén configurados el cortafuegos y la red, es posible que ni siquiera se pueda acceder a la dirección externa desde el servidor de correo y que no se entregue el correo.

El DNS dividido evita este problema al proporcionar un servidor DNS interno (este ejemplo usa bind o dnsmasq) que se puede usar para resolver la dirección interna del servidor. Esta guía detallará cómo configurar un servidor DNS de host único muy específico (es decir, bind o dnsmasq) que se puede instalar en el host de Zimbra para que pueda resolver su propia dirección. Esto no debe usarse para una instalación de Zimbra de múltiples nodos, y no debe usarse como servidor DNS para ningún otro host en su red.

Es posible usar un servidor DNS de horizonte dividido generalizado para realizar esta función, pero deberá configurarse de manera diferente, y muchas personas lo recomiendan porque incluso un par de ms de retraso puede ser demasiado en un sistema muy cargado. Si decide utilizar otro servidor DNS en su LAN, entonces cualquier servidor DNS en funcionamiento que proporcione una respuesta de IP de LAN para la búsqueda de DNS MX del servidor Zimbra servirá (BIND, Active Directory, PowerDNS, etc.), marque la casilla 'Verificar ... . 'en este artículo para obtener detalles sobre cómo verificar que su servidor DNS esté configurado correctamente.

¡Atención! el uso de Bind o dnsmasq son mutuamente excluyentes, ¡tienes que configurar uno O el otro!

Configuración de Bind en el servidor Zimbra
===========================================

Utilice up2date para descargar bind de Red Hat Network.

instalar bind
++++++++++++++
::

	apt-get install bind9

Edite el archivo named.conf
++++++++++++++++++++++++

* Sustituya el nombre de servidor completamente calificado por server.example.com

* Si named se ejecuta en un directorio chroot'ed (es decir, /var/named/chroot), named.conf debe colocarse en /etc/named/chroot/etc/named.conf y debe crear un enlace simbólico a /etc/named.conf,

* es decir, ln -s /etc/named.conf /etc/named/chroot/etc/named.conf

* o ln -s /etc/bind/named.conf /etc/bind/named/chroot/etc/named.conf

Para Red Hat, edite: /etc/named.conf
Para Ubuntu/Kubuntu, edite: /etc/bind/named.conf.options::

	// Default named.conf generated by install of bind-9.2.4-2
	options {
	       directory "/var/named";
	       dump-file "/var/named/data/cache_dump.db";
	       statistics-file "/var/named/data/named_stats.txt";
	forwarders { <address of current DNS server> ; };
	};
	include "/etc/rndc.key";
	// We are the master server for server.example.com
	zone "server.example.com" {
	    type master;
	    file "db.server.example.com";
	};

Asegúrese de configurar los forwarders para que coincidan con los servidores DNS actualmente en uso en su sistema. La configuración de forwarders permite al servidor consultar esos servidores DNS para cualquier dirección para la que no tiene autoridad.

Cree un archivo de zona /var/named/db.server.example.com
++++++++++++++++++++++++++++

Si named se ejecuta en un directorio chroot'ed /var/named/chroot, db.server.example.com debe colocarse en /etc/named/chroot/var/named/db.server.example.com y debe crear un enlace simbólico a /var/named/db.server.example.com::

	;
	;       Addresses and other host information.
	;
	@       IN      SOA     server.example.com. hostmaster.server.example.com. (
		                       10118      ; Serial
		                       43200      ; Refresh
		                       3600       ; Retry
		                       3600000    ; Expire
		                       2592000 )  ; Minimum
	;       Define the nameservers and the mail servers
		IN      NS      <internal address of server>
	yourdomain.com.         IN      MX      10 mail.yourdomain.com.
	mail.yourdomain.com.    IN      A       <internal address of server>

Cambiar /etc/resolv.conf
+++++++++++++++++++++++++

* Cambie /etc/resolv.conf para usar el servidor Zimbra como la dirección DNS principal.

* También recuerde cambiar la ruta de búsqueda para que sea el nombre del servidor Zimbra.

Iniciar named en el servidor de zimbra
++++++++++++++++++++++++++
::

	/etc/init.d/ named start

Habilitar el inicio automático de named en el arranque
+++++++++++++++++++++++++
::

	chkconfig named on

Configuración de dnsmasq en el servidor Zimbra
================================

dnsmasq es una herramienta muy poderosa que puede proporcionar servicios básicos de dns/almacenamiento en caché, actuar como servidor dhcp y también como servidor tftp. También es fácil de configurar. Entonces puede usar dnsmasq EN LUGAR de bind siguiendo estas instrucciones.

instalar dnsmasq en Debian GNU/Linux
+++++++++++++++++++++++++++++++++++++
::

	aptitude install dnsmasq

Edite el archivo /etc/dnsmasq.conf
+++++++++++++++++++++
Digamos que los DNS ascendentes son 8.8.8.8 y 208.67.222.222. Pon solo estas líneas en el archivo de configuración::

	server=8.8.8.8
	server=208.67.222.222
	domain=yourdomain.com
	mx-host=yourdomain.com,mail.yourdomain.com,5
	listen-address=127.0.0.1


Edite el archivo /etc/hosts
++++++++++++++

La línea de bucle invertido debería verse así::

	127.0.0.1 localhost.localdomain localhost

Necesita una línea para resolver la IP de mail.yourdomain.com a la IP privada del servidor de zimbra, así que asegúrese de tener::

	192.168.1.30    mail.yourdomain.com mail


Edite el archivo /etc/resolv.conf
+++++++++++++++++++++++
Para que el host se resuelva a través de dnsmasq, debe configurar su host local (127.0.0.1) como servidor de nombres::

	search yourdomain.com
	nameserver 127.0.0.1

Reiniciar dnsmasq
++++++++++++++
Para que la configuración surta efecto, debe reiniciar dnsmasq::

	/etc/init.d/dnsmasq restart

Verifica que todo esté funcionando
++++++++++++++++++++++++++++++++++++
Para verificar que su configuración de DNS es correcta, debe ejecutar los siguientes comandos en el servidor Zimbra (la salida esperada se encuentra en los cuadros debajo de los comandos): Esto es cierto para cualquier programa de DNS que use para este tipo de configuración (es decir, dnsmasq en lugar de bind9).

**dig yourdomain.com mx**::

	; <<>> DiG 9.3.6-P1-RedHat-9.3.6-4.P1.el5_4.2 <<>> yourdomain.com mx
	;; global options:  printcmd
	;; Got answer:
	;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 20907
	;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 2

	;; QUESTION SECTION:
	;yourdomain.com.                IN      MX

	;; ANSWER SECTION:
	yourdomain.com. 7200    IN      MX      30 mail.yourdomain.com.

	;; ADDITIONAL SECTION:
	mail.yourdomain.com. 7200 IN  A       192.168.1.30

	;; Query time: 4 msec
	;; SERVER: 192.168.1.10#53(192.168.1.10)
	;; WHEN: Thu Jul 15 14:38:48 2010
	;; MSG SIZE  rcvd: 140

**dig yourdomain.com any**

	; <<>> DiG 9.3.6-P1-RedHat-9.3.6-4.P1.el5_4.2 <<>> yourdomain.com any
	;; global options:  printcmd
	;; Got answer:
	;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36845
	;; flags: qr aa rd ra; QUERY: 1, ANSWER: 8, AUTHORITY: 0, ADDITIONAL: 4

	;; QUESTION SECTION:
	;yourdomain.com.                IN      ANY

	;; ANSWER SECTION:
	yourdomain.com. 7200    IN      NS      ns1.yourdomain.com.
	yourdomain.com. 7200    IN      A       192.168.1.30
	yourdomain.com. 7200    IN      SOA     yourdomain.com. admin. 2010051304 10800 3600 1814400 7200
	yourdomain.com. 7200    IN      MX      10 mail.yourdomain.com.
	yourdomain.com. 7200    IN      NS      ns2.yourdomain.com.

	;; ADDITIONAL SECTION:
	mail.yourdomain.com. 7200 IN     A       192.168.1.30
	ns2.yourdomain.com.  7200 IN     A       192.168.1.11
	ns1.yourdomain.com.  7200 IN     A       192.168.1.10 

	;; Query time: 11 msec
	;; SERVER: 192.168.1.10#53(192.168.1.10)
	;; WHEN: Thu Jul 15 14:38:52 2010
	;; MSG SIZE  rcvd: 367

**host $(hostname)**

	mail.yourdomain.com has address 192.168.1.30

**NOTA**: El comando host $(hostname) debe escribirse exactamente como ve, no cambie la palabra "nombre de host" por ninguna otra cosa.

También debe tener en cuenta que la salida en su sistema puede ser ligeramente diferente a los ejemplos anteriores, pero debe haber un registro A que apunte a la dirección IP de LAN de su servidor Zimbra y un registro MX que contenga el FQDN (Nombre de dominio completo, eso es el nombre de host más el nombre de dominio y es mail.yourdomain.com en los ejemplos) de su servidor Zimbra.

También debe asegurarse de que el servidor DNS que responde a sus comandos de excavación sea el que ha configurado en su LAN y es el que tiene los registros DNS de su servidor Zimbra. Si ve alguna IP que no es la IP de LAN correcta o el servidor DNS correcto, entonces ha ingresado la información incorrecta en sus archivos de configuración de DNS.

Si se le solicita en los foros que proporcione la información para confirmar que su DNS es correcto, entonces, además de la información anterior, también debe proporcionar el resultado de los siguientes comandos (ejecutar en su servidor Zimbra)::

	cat /etc/resolv.conf
	cat /etc/hosts


En este artículo se asume que está instalando el servidor DNS en su servidor Zimbra, por lo que su resolv.conf debería verse así::

	search yourdomain.com
	nameserver 127.0.0.1

Aunque se menciona en otros artículos, vale la pena repetir que su archivo de hosts debería verse así::

	127.0.0.1 localhost.localdomain localhost
	192.168.1.30 mail.yourdomain.com mail

La línea para el adaptador de bucle invertido (127.0.0.1) debe formatearse como se muestra. El archivo de hosts también debe tener el formato que se muestra y tener la IP de LAN de su servidor Zimbra (como se muestra en los registros DNS) y contener el nombre de host (correo) y su nombre de dominio (yourdomain.com) que le da el nombre de dominio completo (FQDN) de su servidor 'mail.yourdomain.com'.

Si tiene varios servidores dentro del firewall que necesitan usar direcciones internas para comunicarse entre sí, debería considerar configurar un servidor DNS interno completo que pueda tener autoridad para todo el dominio. Este ejemplo no es adecuado para esta tarea.



**Article ID: https://wiki.zimbra.com/index.php?title=Split_DNS**
https://wiki.zimbra.com/wiki/Split_DNS

